{{- printf `<?xml version="1.0" encoding="utf-8" standalone="yes"?>` | safeHTML }}
<rss version="2.0" 
     xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd" 
     xmlns:atom="http://www.w3.org/2005/Atom" 
     xmlns:content="http://purl.org/rss/1.0/modules/content/" 
     xmlns:media="http://search.yahoo.com/mrss/" 
     xmlns:podcast="https://podcastindex.org/namespace/1.0"
     xmlns:psc="http://podlove.org/simple-chapters">
  <channel>
    <title>{{ .Site.Title }}{{ if not .IsHome }} - {{ .Title }}{{ end }}</title>
    <link>{{ .Permalink }}</link>
    <description>{{ .Site.Params.description }}</description>
    {{ with .Site.LanguageCode }}<language>{{ . }}</language>{{ end }}
    <copyright>Creative Commons BY-SA 3.0 DE</copyright>
    <lastBuildDate>{{ now.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</lastBuildDate>
    <atom:link href="{{ .Permalink }}rss.xml" rel="self" type="application/rss+xml" />
    
    <itunes:author>{{ .Site.Params.author }}</itunes:author>
    <itunes:subtitle>Web, Technologie und OpenSource Software</itunes:subtitle>
    <itunes:summary>{{ .Site.Params.description }}</itunes:summary>
    <itunes:keywords>technology, gadgets, web, opensource, krepel</itunes:keywords>
    <itunes:explicit>no</itunes:explicit>
    <itunes:image href="http://blog.binaergewitter.de/img/binaergewitter_logo_1400x1400.png" />
    <itunes:category text="Technology" />
    <itunes:owner>
      <itunes:name>Bin√§rgewitter Crew</itunes:name>
      <itunes:email>info@binaergewitter.de</itunes:email>
    </itunes:owner>

    {{ range first 50 (where .Site.RegularPages "Section" "post") }}
    <item>
      <title>{{ .Title }}</title>
      <link>{{ .Permalink }}</link>
      <pubDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</pubDate>
      <guid isPermaLink="{{ if .Params.release }}false{{ else }}true{{ end }}">{{ .Permalink }}{{ with .Params.release }}-{{ . }}{{ end }}</guid>
      <description>{{ .Summary | html }}</description>
      <content:encoded>{{ .Content | html }}</content:encoded>
      
      <itunes:author>{{ $.Site.Params.author }}</itunes:author>
      <itunes:summary>{{ .Summary | plainify | html }}</itunes:summary>
      
      {{ $audioFormats := .Params.audioformats }}
      {{ if $audioFormats }}
        {{ $firstFormat := "mp3" }}
        {{ if index $audioFormats "mp3" }}
          {{ $firstFormat = "mp3" }}
        {{ else }}
          {{ range $k, $v := $audioFormats }}{{ $firstFormat = $k }}{{ end }}
        {{ end }}
        {{ $url := index $audioFormats $firstFormat }}
        
        {{ $metaUrl := replace $url (printf ".%s" $firstFormat) ".json" }}
        {{ $meta := "" }}
        {{ with resources.GetRemote $metaUrl }}
          {{ with .Content }}
            {{ $meta = . | transform.Unmarshal }}
          {{ end }}
        {{ end }}
        
        {{ $duration := "00:00:00" }}
        {{ $size := 0 }}
        {{ if $meta }}
          {{ if reflect.IsMap $meta }}
            {{ with index $meta "length_timestring" }}
              {{ $duration = index (split . ".") 0 }}
            {{ end }}
            {{ range index $meta "output_files" }}
              {{ if eq (index . "ending") $firstFormat }}
                {{ $size = index . "size" }}
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}

        <enclosure url="{{ $url }}" length="{{ $size }}" type="audio/{{ $firstFormat }}" />
        <itunes:duration>{{ $duration }}</itunes:duration>

        {{ $chaptersUrl := .Params.chapters | default (replace $url (printf ".%s" $firstFormat) ".chapters.txt") }}
        {{ $chaptersRaw := "" }}
        {{ with resources.GetRemote $chaptersUrl }}
          {{ $chaptersRaw = .Content }}
        {{ end }}

        {{ if $chaptersRaw }}
          <psc:chapters version="1.2">
            {{ $lines := split $chaptersRaw "\n" }}
            {{ range $lines }}
              {{ $line := trim . " \r" }}
              {{ if $line }}
                {{ $parts := split $line " " }}
                {{ if ge (len $parts) 2 }}
                  <psc:chapter start="{{ index $parts 0 }}" title="{{ delimit (after 1 $parts) " " | html }}" />
                {{ end }}
              {{ end }}
            {{ end }}
          </psc:chapters>
        {{ end }}
      {{ end }}

      {{ range $name, $val := .Params.voices }}
        {{ if $val }}
          <podcast:person>{{ $name }}</podcast:person>
        {{ end }}
      {{ end }}
    </item>
    {{ end }}
  </channel>
</rss>
